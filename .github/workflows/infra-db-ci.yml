name: CI/CD - Infra DB

on:
  pull_request:
    branches: [ develop, homolog, master ]
  push:
    branches: [ develop, homolog, master ]

env:
  DOTNET_VERSION: 8.0.x

jobs:
  terraform:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set deployment flag
      run: |
        if [ "${GITHUB_EVENT_NAME}" = "push" ] && { [ "${GITHUB_REF}" = "refs/heads/homolog" ] || [ "${GITHUB_REF}" = "refs/heads/master" ]; }; then
          echo "DEPLOY_ENABLED=true" >> "$GITHUB_ENV"
        else
          echo "DEPLOY_ENABLED=false" >> "$GITHUB_ENV"
        fi

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.6.6
        terraform_wrapper: false

    - name: Terraform Init
      working-directory: ./terraform
      run: terraform init -input=false

    - name: Terraform Validate
      working-directory: ./terraform
      run: terraform validate

    - name: Terraform Plan
      if: github.event_name == 'pull_request'
      working-directory: ./terraform
      run: terraform plan -input=false -var="enable_db=true"

    - name: Terraform Plan (push)
      if: env.DEPLOY_ENABLED == 'true'
      working-directory: ./terraform
      run: terraform plan -input=false -var="enable_db=true" -out=tfplan

    - name: Terraform Apply
      if: env.DEPLOY_ENABLED == 'true'
      working-directory: ./terraform
      run: terraform apply -input=false -auto-approve tfplan

    - name: Checkout projeto de app (migrations)
      if: env.DEPLOY_ENABLED == 'true'
      uses: actions/checkout@v4
      with:
        repository: marciocardozodev/OficinaCardozo.App
        path: app-code
        fetch-depth: 0
        ref: master

    - name: Setup .NET para migrations
      if: env.DEPLOY_ENABLED == 'true'
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Instalar dotnet-ef
      if: env.DEPLOY_ENABLED == 'true'
      run: dotnet tool install --global dotnet-ef --version 8.0.11

    - name: Obter outputs do RDS
      if: env.DEPLOY_ENABLED == 'true'
      id: rds_outputs
      working-directory: ./terraform
      run: |
        echo "RDS_HOST=$(terraform output -raw rds_host)" >> $GITHUB_ENV
        echo "RDS_USER=$(terraform output -raw rds_user)" >> $GITHUB_ENV
        echo "RDS_PASS=$(terraform output -raw rds_password)" >> $GITHUB_ENV
        echo "RDS_DB=$(terraform output -raw rds_db_name)" >> $GITHUB_ENV

    - name: Rodar migrations EF Core no RDS
      if: env.DEPLOY_ENABLED == 'true'
      run: |
        export PATH="$PATH:/home/runner/.dotnet/tools"
        CONNECTION_STRING="Host=${RDS_HOST};Port=5432;Database=${RDS_DB};Username=${RDS_USER};Password=${RDS_PASS};Ssl Mode=Require;Trust Server Certificate=true;"
        export ConnectionStrings__DefaultConnection="$CONNECTION_STRING"
        export ASPNETCORE_ENVIRONMENT="Production"
        export CONFIGURACOESJWT__CHAVESECRETA="ZnE1b0h0b3pNQXpmdGRsa2RTc2IyN3dueVJkaWtvQ3dQazFFenU2WEdBSHB1bE93QmpHTlBnU0Q5TXl5SU5WODlRendCQzFyb0tFcFVTUldBTWQ3bDBNRlFhVjVpc25pVVBXNUt2RmUxVnZlQ2JHU29Eazk5N29UczJWMFAwbjI"
        export API_PROJECT_PATH="app-code/OficinaCardozo.API"
        dotnet restore app-code/OficinaCardozo.Infrastructure/OficinaCardozo.Infrastructure.csproj
        dotnet restore app-code/OficinaCardozo.API/OficinaCardozo.API.csproj
        dotnet ef database update --project app-code/OficinaCardozo.Infrastructure/OficinaCardozo.Infrastructure.csproj --startup-project app-code/OficinaCardozo.API/OficinaCardozo.API.csproj
